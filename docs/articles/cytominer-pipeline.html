<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to cytominer • cytominer</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">cytominer</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cytominer-pipeline.html">Introduction to cytominer</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/shntnu/cytominer">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Introduction to cytominer</h1>
                        <h4 class="author">Allen Goodman and Shantanu Singh</h4>
            
            <h4 class="date">2017-09-08</h4>
          </div>

    
    
<div class="contents">
<pre><code>## NULL</code></pre>
<p>Typical morphological profiling datasets have millions of cells and hundreds of features per cells. When working with this data, you must</p>
<ul>
<li><p>clean the data</p></li>
<li><p>normalize the features so that they are comparable across experiments</p></li>
<li><p>transform the features so that their distributions are well-behaved ( i.e., bring them in line with assumptions we want to make about their disributions)</p></li>
<li><p>select features based on their quality</p></li>
<li><p>aggregate the single-cell data, if needed</p></li>
</ul>
<p>The cytominer package makes these steps fast and easy.</p>
<div id="load-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load data</h2>
<p>First, load the data, which is stored in a database backend created using <a href="https://github.com/cytomining/cytominer-database" class="uri">https://github.com/cytomining/cytominer-database</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fixture &lt;-
<span class="st">  </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"fixture_intensities_shapes.sqlite"</span>,
              <span class="dt">package =</span> <span class="st">"cytominer"</span>)

db &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), fixture)</code></pre></div>
<p>Then load associated metadata if it exists, and copy it to the backend so that we can use it later.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ext_metadata &lt;-
<span class="st">  </span>readr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/readr/topics/read_delim">read_csv</a></span>(<span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"metadata.csv"</span>,
                              <span class="dt">package =</span> <span class="st">"cytominer"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">g_well =</span> Well)</code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   Well = col_character(),
##   Type = col_character()
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ext_metadata &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(db, ext_metadata)</code></pre></div>
<p>Next, select a measurement table that you want to work. Here, we will pick <code>intensities</code> but we can easily extend to using multiple or all measurement classes if needed by creating new views.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intensities &lt;-
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="dt">src =</span> db, <span class="st">"view_intensities"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">compute</a></span>()</code></pre></div>
<p>For this example, lets filter the data down to a few wells.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">measurements &lt;-
<span class="st">  </span>intensities <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(g_well <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"A01"</span>, <span class="st">"A02"</span>, <span class="st">"A10"</span>, <span class="st">"A11"</span>))</code></pre></div>
<p>How many rows does this table have?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">measurements <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tally.html">tally</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">n</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">360</td>
</tr></tbody>
</table>
<p>That actually 9 times the number of cells in this experiment (n = 40): each compartment and each channel gets its own row. Here, we have 3 compartments (cell, nucleus, cytoplasm) and 3 channels (CellMask, Hoechst, Alexa568). So that’s 3 x 3 x 40 = 360.</p>
<p>Next, do some setup stuff that we will need later</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qc_cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"q_debris"</span>)

group_cols &lt;-
<span class="st">  </span><span class="kw">c</span>(<span class="st">"g_plate"</span>,
    <span class="st">"g_well"</span>,
    <span class="st">"g_image"</span>,
    <span class="st">"g_pattern"</span>,
    <span class="st">"g_channel"</span>)

feature_cols &lt;-
<span class="st">  </span><span class="kw">colnames</span>(measurements) <span class="op">%&gt;%</span>
<span class="st">  </span>stringr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_subset">str_subset</a></span>(<span class="st">"^m_"</span>)

measurements <span class="op">%&lt;&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select_helpers.html">one_of</a></span>(<span class="kw">c</span>(group_cols, qc_cols, feature_cols)))</code></pre></div>
</div>
<div id="clean" class="section level2">
<h2 class="hasAnchor">
<a href="#clean" class="anchor"></a>Clean</h2>
<p>Let’s remove cells that come from images that were marked as having debris</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">debris_removed &lt;-
<span class="st">  </span>measurements <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(q_debris <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<p>Then, remove cells where all the measurements are NA’s - this may happen if the identified cell mask was too small to measure any of the features.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">na_rows_removed &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/drop_na_rows">drop_na_rows</a></span>(
    <span class="dt">population =</span> debris_removed,
    <span class="dt">variables =</span> feature_cols
  ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">compute</a></span>()</code></pre></div>
</div>
<div id="normalize" class="section level2">
<h2 class="hasAnchor">
<a href="#normalize" class="anchor"></a>Normalize</h2>
<p>We need to normalize the data so that</p>
<ul>
<li><p>features are on the same scale</p></li>
<li><p>plate-to-plate variation is reduced</p></li>
</ul>
<p>The default for doing this is <code>standardization</code>. Here, we take all the cells from control wells in the experiment (this is where the external metadata gets used) and compute normalizations parameters from that (in this case, just the mean and s.d.) and then apply it to the whole dataset (i.e. the population)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">normalized &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/normalize">normalize</a></span>(
    <span class="dt">population =</span> na_rows_removed <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>(),
    <span class="dt">variables =</span> feature_cols,
    <span class="dt">strata =</span>  <span class="kw">c</span>(<span class="st">"g_plate"</span>, <span class="st">"g_pattern"</span>, <span class="st">"g_channel"</span>),
    <span class="dt">sample =</span>
      na_rows_removed <span class="op">%&gt;%</span>
<span class="st">      </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(
        ext_metadata <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Type <span class="op">==</span><span class="st"> "ctrl"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(g_well) 
      ) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()
  )</code></pre></div>
<pre><code>## Joining, by = "g_well"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">normalized <span class="op">%&lt;&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()</code></pre></div>
<p>In some cases, we may have features that have no variance at all (e.g. Euler number). If these features have not already been removed by this stage, the standardization step will results in all values for that feature being NA ( because s.d. = 0). Lets remove them:</p>
<p>First, count how many cells have NA values per feature:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">na_frequency &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/count_na_rows">count_na_rows</a></span>(
    <span class="dt">population =</span> normalized,
    <span class="dt">variables =</span> feature_cols)

na_frequency <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(feature, na_count) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">na_count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">m_intensities_first_quartile</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">m_intensities_integrated</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">m_intensities_maximum</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">m_intensities_mean</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">m_intensities_median</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">m_intensities_median_absolute_deviation</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">m_intensities_minimum</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">m_intensities_standard_deviation</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">m_intensities_third_quartile</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>As it turns out, no feature has NA in this example. But lets run this cleaning operation anyway (no features will be dropped)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cleaned &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/select">select</a></span>(
    <span class="dt">population =</span> normalized,
    <span class="dt">variables =</span> feature_cols,
    <span class="dt">operation =</span> <span class="st">"drop_na_columns"</span>
)</code></pre></div>
</div>
<div id="transform" class="section level2">
<h2 class="hasAnchor">
<a href="#transform" class="anchor"></a>Transform</h2>
<p>Tranform the data so that assumptions we may later make about the data distribution are satisfied (e.g. Gaussianity). The default here is <code>generalized_log</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">transformed &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/transform">transform</a></span>(
    <span class="dt">population =</span> cleaned,
    <span class="dt">variables =</span> feature_cols
  )</code></pre></div>
</div>
<div id="select-features" class="section level2">
<h2 class="hasAnchor">
<a href="#select-features" class="anchor"></a>Select features</h2>
<p>Finally, we typically perform feature selection on the data. Feature selection is an expensive operation, so we usually want to train the feature selection model on a sample of the dataset. Here, we choose to aggregate the data instead of sampling it (i.e. collapse it to per-well aggregates)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aggregated &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/aggregate">aggregate</a></span>(
    <span class="dt">population =</span> transformed,
    <span class="dt">variables =</span> feature_cols,
    <span class="dt">strata =</span> group_cols
  ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()</code></pre></div>
<p>… and then apply feature selection on the per-cell data. Here <code>correlation_threshold</code> - a method that reduces the redundancy of features - is used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">selected &lt;-
<span class="st">  </span>cytominer<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/cytominer/topics/select">select</a></span>(
    <span class="dt">population =</span> transformed,
    <span class="dt">variables =</span> feature_cols,
    <span class="dt">sample =</span> aggregated,
    <span class="dt">operation =</span> <span class="st">"correlation_threshold"</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()</code></pre></div>
<p>And now lets take a glimpse at the data!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">selected <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">glimpse</a></span>()</code></pre></div>
<pre><code>## Observations: 315
## Variables: 10
## $ g_plate                                 &lt;chr&gt; "110000106828", "11000...
## $ g_well                                  &lt;chr&gt; "A01", "A01", "A01", "...
## $ g_image                                 &lt;chr&gt; "5a822385194aceb347a07...
## $ g_pattern                               &lt;chr&gt; "Cells", "Cells", "Cel...
## $ g_channel                               &lt;chr&gt; "Alexa568", "Alexa568"...
## $ q_debris                                &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0...
## $ m_intensities_integrated                &lt;dbl&gt; -1.48831626, -0.067616...
## $ m_intensities_maximum                   &lt;dbl&gt; -1.25783096, -1.514831...
## $ m_intensities_median_absolute_deviation &lt;dbl&gt; -1.4847843, -0.5372476...
## $ m_intensities_minimum                   &lt;dbl&gt; -2.3552231, -1.9025552...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbDisconnect">dbDisconnect</a></span>(db)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#load-data">Load data</a></li>
      <li><a href="#clean">Clean</a></li>
      <li><a href="#normalize">Normalize</a></li>
      <li><a href="#transform">Transform</a></li>
      <li><a href="#select-features">Select features</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Tim Becker, Allen Goodman, Claire McQuin, Mohammad Rohban, Shantanu Singh.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
